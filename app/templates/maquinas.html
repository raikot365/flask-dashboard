{% extends "layout.html" %}
{% block body %}
<div class="container mt-4">
  <div id="checkboxes-maquinas" class="d-flex flex-wrap gap-2 mb-4">
    {% for m in maquinas %}
      <div class="form-check btn-secondary" style="padding:3px 5px 3px 30px; border-radius:6px;">
        <input class="form-check-input"
               type="checkbox"
               id="check-{{ m }}"
               checked
               onchange="toggleMaquina({{ m }})">
        <label class="form-check-label" for="check-{{ m }}">
          Máquina Nº {{ m }}
        </label>
      </div>
    {% endfor %}
  </div>

  <div id="maquinas-list">
    {% for m in maquinas %}
    <div class="maquina-block mb-5" id="maquina-block-{{ m }}">
      <div class="row align-items-start">
        <div class="col-md-8">
          <h6 class="text-center">Máquina {{ m }}</h6>
          <canvas id="chart-{{ m }}" height="100"></canvas>
        </div>
        <div class="col-md-4">
          <div id="resumen-{{ m }}"></div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const date  = urlParams.get('date');
  const turno = urlParams.get('turno');
  const start = urlParams.get('start');
  const end   = urlParams.get('end');
  const maquinas = {{ maquinas|tojson|safe }};

  function toggleMaquina(m) {
    const block = document.getElementById(`maquina-block-${m}`);
    const chk   = document.getElementById(`check-${m}`);
    block.style.display = chk.checked ? '' : 'none';
  }

  async function fetchAndRender(m) {
    let apiUrl;
    if (start && end) {
      apiUrl = `/api/maquina/${m}?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
    } else if (date && turno) {
      apiUrl = `/api/maquina/${m}?date=${encodeURIComponent(date)}&turno=${encodeURIComponent(turno)}`;
    } else {
      return;
    }

    const res = await fetch(apiUrl);
    const parent = document.getElementById(`chart-${m}`).parentElement;
    if (!res.ok) {
      parent.innerHTML = '<p class="text-center text-muted">Error al obtener datos.</p>';
      return;
    }

    const { data } = await res.json();
    if (!data || data.length === 0) {
      parent.innerHTML = '<p class="text-center text-muted">No hay datos.</p>';
      return;
    }

    // Prepara series
    const times = data.map(d => new Date(d.time));
    const mOn   = data.map(d => d.mOn);
    const mWo   = data.map(d => d.mWo);
    const fullH = 1;
    const datasets = [
      {
        label: 'Fondo Apagada',
        data: data.map(d => ({ x: new Date(d.time), y: d.mOn===0 ? fullH : 0 })),
        backgroundColor: 'rgba(255,0,0,0.2)',
        borderColor: 'transparent', fill:'origin',
        stepped:true, pointRadius:0, order:3
      },
      {
        label: 'Fondo Encendida sin producir',
        data: data.map(d => ({ x: new Date(d.time),
                               y: d.mOn===1 && d.mWo===0 ? fullH : 0 })),
        backgroundColor: 'rgba(255,165,0,0.2)',
        borderColor: 'transparent', fill:'origin',
        stepped:true, pointRadius:0, order:2
      },
      {
        label: 'Fondo Produciendo',
        data: data.map(d => ({ x: new Date(d.time),
                               y: d.mOn===1 && d.mWo===1 ? fullH : 0 })),
        backgroundColor: 'rgba(0,128,0,0.2)',
        borderColor: 'transparent', fill:'origin',
        stepped:true, pointRadius:0, order:1
      },
      {
        label: 'Encendida',
        data: times.map((t,i)=>({x:t,y: mOn[i]===1?1:0})),
        stepped:true, borderColor:'#4caf50', pointRadius:0, order:0
      },
      {
        label: 'Produciendo',
        data: times.map((t,i)=>({x:t,y: mWo[i]===1?0.8:0})),
        stepped:true, borderColor:'#2196f3', pointRadius:0, order:0
      }
    ];

    const ctx = document.getElementById(`chart-${m}`).getContext('2d');
    if (Chart.getChart(ctx)) Chart.getChart(ctx).destroy();

    new Chart(ctx, {
      type: 'line',
      data: { datasets },
      options: {
        interaction: { mode: 'index', intersect: false },
        plugins: {
          title: {
            display: true,
            text: start && end
              ? `Máquina ${m} — ${start} → ${end}`
              : `Máquina ${m} — ${date} - ${turno}`
          },
          tooltip: {
            callbacks: {
              label: ctx => {
                const y = ctx.parsed.y;
                if (y === 1)   return 'Encendida';
                if (y === 0.8) return 'Produciendo';
                return 'Apagada';
              }
            }
          },
          legend: {
            labels: {
              filter: item => !item.text.startsWith('Fondo ')
            }
          }
        },
        scales: {
          x: {
            type:'time', time:{unit:'hour',displayFormats:{hour:'HH:mm'}},
            ticks:{autoSkip:false,
              callback:(v,i,ticks)=>new Date(ticks[i].value)
                .toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'})
            },
            title:{display:true,text:'Hora'}
          },
          y: {
            min:0, max:1.1,
            ticks:{callback:v=>{
              if      (v===1)   return 'Encendida';
              else if (v===0.8) return 'Produciendo';
              else if (v===0)   return 'Apagada';
              else return '';
            }},
            title:{display:true,text:'Estado'}
          }
        }
      }
    });

    // Resumen textual
    const resumen = { apagada:0, encendida:0, produciendo:0 };
    data.forEach(d=>{
      if      (d.mOn===0)        resumen.apagada++;
      else if (d.mWo===1)        resumen.produciendo++;
      else                        resumen.encendida++;
    });
    const total = data.length, totalMin = total*3;
    const lineHTML = (n,v)=>{
      const mins = v*3, pct = ((mins/totalMin)*100).toFixed(1);
      return `<strong>${n}</strong>: ${mins} min (${pct}%)`;
    };
    const t0 = times[0].toLocaleString('es-AR',{dateStyle:'short',timeStyle:'medium'});
    const t1 = times[total-1].toLocaleString('es-AR',{dateStyle:'short',timeStyle:'medium'});
    document.getElementById(`resumen-${m}`).innerHTML = `
      <div class="alert alert-light mt-2">
        ${lineHTML('Produciendo',   resumen.produciendo)}<br>
        ${lineHTML('Encendida sin producir', resumen.encendida)}<br>
        ${lineHTML('Apagada',       resumen.apagada)}<br>
        <strong>Inicio:</strong> ${t0}<br>
        <strong>Fin:</strong> ${t1}<br>
        <strong># muestras:</strong> ${total}
      </div>
    `;
  }

  window.addEventListener('DOMContentLoaded', () => {
    maquinas.forEach(m => fetchAndRender(m));
  });

  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('navTortasBtn');
    if (btn) {
      const urlParams = new URLSearchParams(window.location.search);
      const date  = urlParams.get('date');
      const turno = urlParams.get('turno');
      const start = urlParams.get('start');
      const end   = urlParams.get('end');
      let href;

      if (start && end) {
        href = `/?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
      } else if (date && turno) {
        href = `/?date=${encodeURIComponent(date)}&turno=${encodeURIComponent(turno)}`;
      } else {
        href = '/';
      }

      btn.setAttribute('href', href);
    }
  });
</script>
{% endblock %}
